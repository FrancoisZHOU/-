<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å·¥æ—¶è®°å½•">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23667eea' rx='100'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='280' fill='white' font-family='Arial'%3Eâ°%3C/text%3E%3C/svg%3E">
    <title>å‘˜å·¥å·¥æ—¶è®°å½•ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-export {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            margin-top: 20px;
        }

        .records-section {
            margin-top: 30px;
        }

        .month-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .month-selector h2 {
            color: #333;
            font-size: 1.5em;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .hours {
            font-size: 2em;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #ff3838;
        }

        .no-records {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .time-inputs {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ´ é¤é¦†å‘˜å·¥å·¥æ—¶è®°å½•</h1>

        <div class="input-section">
            <h2 style="margin-bottom: 20px; color: #333;">æ·»åŠ å·¥æ—¶è®°å½•</h2>
            
            <div class="form-group">
                <label>é€‰æ‹©å‘˜å·¥</label>
                <select id="employeeSelect">
                    <option value="Lilou">Lilou</option>
                    <option value="Jules">Jules</option>
                    <option value="Charline">Charline</option>
                </select>
            </div>

            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="dateInput">
            </div>

            <div class="time-inputs">
                <div class="form-group">
                    <label>ä¸Šç­æ—¶é—´</label>
                    <input type="time" id="startTime">
                </div>
                <div class="form-group">
                    <label>ä¸‹ç­æ—¶é—´</label>
                    <input type="time" id="endTime">
                </div>
            </div>

            <button class="btn" onclick="addRecord()">æ·»åŠ è®°å½•</button>
        </div>

        <div class="records-section">
            <div class="month-selector">
                <h2 id="currentMonth"></h2>
                <button class="btn-export btn" onclick="exportToExcel()" style="width: auto;">ğŸ“¥ å¯¼å‡ºæœ¬æœˆExcel</button>
            </div>

            <div class="summary-cards" id="summaryCards"></div>

            <table>
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>å‘˜å·¥</th>
                        <th>ä¸Šç­æ—¶é—´</th>
                        <th>ä¸‹ç­æ—¶é—´</th>
                        <th>å·¥ä½œæ—¶é•¿</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="recordsTable">
                    <tr>
                        <td colspan="6" class="no-records">æš‚æ— è®°å½•</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–
        document.getElementById('dateInput').valueAsDate = new Date();
        updateDisplay();

        // æ³¨å†ŒService Workerç”¨äºPWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(() => console.log('Service Worker æ³¨å†ŒæˆåŠŸ'))
                .catch((err) => console.log('Service Worker æ³¨å†Œå¤±è´¥:', err));
        }

        // æç¤ºç”¨æˆ·å¯ä»¥å®‰è£…åº”ç”¨
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºå®‰è£…æç¤º
            console.log('å¯ä»¥å®‰è£…PWAåº”ç”¨äº†ï¼');
        });

        // æ·»åŠ è®°å½•
        function addRecord() {
            try {
                console.log('å¼€å§‹æ·»åŠ è®°å½•...');
                
                const employee = document.getElementById('employeeSelect').value;
                const date = document.getElementById('dateInput').value;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;

                console.log('å‘˜å·¥:', employee, 'æ—¥æœŸ:', date, 'ä¸Šç­:', startTime, 'ä¸‹ç­:', endTime);

                if (!date || !startTime || !endTime) {
                    alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼\næ—¥æœŸ:' + (date ? 'âœ“' : 'âœ—') + '\nä¸Šç­æ—¶é—´:' + (startTime ? 'âœ“' : 'âœ—') + '\nä¸‹ç­æ—¶é—´:' + (endTime ? 'âœ“' : 'âœ—'));
                    return;
                }

                // è®¡ç®—å·¥ä½œæ—¶é•¿
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(`2000-01-01T${endTime}`);
                
                if (end <= start) {
                    alert('ä¸‹ç­æ—¶é—´å¿…é¡»æ™šäºä¸Šç­æ—¶é—´ï¼');
                    return;
                }

                const totalMinutes = (end - start) / (1000 * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = Math.round(totalMinutes % 60);
                const hoursDecimal = (totalMinutes / 60).toFixed(2);
                
                console.log('å·¥ä½œæ—¶é•¿:', hours, 'å°æ—¶', minutes, 'åˆ†é’Ÿ');

                // æµ‹è¯•localStorage
                if (typeof(Storage) === "undefined") {
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæœ¬åœ°å­˜å‚¨åŠŸèƒ½ï¼è¯·ä½¿ç”¨Chromeã€Safariæˆ–Firefoxæµè§ˆå™¨ã€‚');
                    return;
                }

                // è·å–ç°æœ‰è®°å½•
                let records = JSON.parse(localStorage.getItem('timeRecords') || '[]');
                console.log('ç°æœ‰è®°å½•æ•°:', records.length);

                // æ·»åŠ æ–°è®°å½•
                const newRecord = {
                    id: Date.now(),
                    employee,
                    date,
                    startTime,
                    endTime,
                    hours: hoursDecimal,
                    hoursDisplay: `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`
                };
                
                records.push(newRecord);
                console.log('æ–°è®°å½•:', newRecord);

                // ä¿å­˜
                localStorage.setItem('timeRecords', JSON.stringify(records));
                console.log('ä¿å­˜æˆåŠŸï¼æ€»è®°å½•æ•°:', records.length);

                // æ¸…ç©ºè¾“å…¥
                document.getElementById('startTime').value = '';
                document.getElementById('endTime').value = '';

                // æ›´æ–°æ˜¾ç¤º
                updateDisplay();
                
                alert('âœ… è®°å½•æ·»åŠ æˆåŠŸï¼\nå‘˜å·¥: ' + employee + '\nå·¥ä½œæ—¶é•¿: ' + hours + 'å°æ—¶' + minutes + 'åˆ†é’Ÿ');
                
            } catch (error) {
                console.error('æ·»åŠ è®°å½•å‡ºé”™:', error);
                alert('âŒ æ·»åŠ å¤±è´¥ï¼é”™è¯¯ä¿¡æ¯: ' + error.message);
            }
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;

            let records = JSON.parse(localStorage.getItem('timeRecords') || '[]');
            records = records.filter(r => r.id !== id);
            localStorage.setItem('timeRecords', JSON.stringify(records));
            updateDisplay();
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            const records = JSON.parse(localStorage.getItem('timeRecords') || '[]');
            
            // è·å–å½“å‰æœˆä»½
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('currentMonth').textContent = 
                `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆå·¥æ—¶ç»Ÿè®¡`;

            // è¿‡æ»¤æœ¬æœˆè®°å½•
            const monthRecords = records.filter(r => r.date.startsWith(currentMonth));

            // è®¡ç®—æ¯äººæ€»å·¥æ—¶
            const employeeHours = {
                'Lilou': 0,
                'Jules': 0,
                'Charline': 0
            };

            monthRecords.forEach(r => {
                employeeHours[r.employee] += parseFloat(r.hours);
            });

            // æ›´æ–°æ±‡æ€»å¡ç‰‡
            const summaryHtml = Object.keys(employeeHours).map(name => {
                const totalMinutes = employeeHours[name] * 60;
                const hrs = Math.floor(totalMinutes / 60);
                const mins = Math.round(totalMinutes % 60);
                return `
                <div class="summary-card">
                    <h3>${name}</h3>
                    <div class="hours">${hrs}å°æ—¶${mins}åˆ†</div>
                </div>
                `;
            }).join('');
            document.getElementById('summaryCards').innerHTML = summaryHtml;

            // æ›´æ–°è¡¨æ ¼
            const tbody = document.getElementById('recordsTable');
            
            if (monthRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-records">æœ¬æœˆæš‚æ— è®°å½•</td></tr>';
                return;
            }

            // æŒ‰æ—¥æœŸæ’åº
            monthRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = monthRecords.map(r => {
                // è½¬æ¢æ˜¾ç¤ºæ ¼å¼
                const totalMinutes = parseFloat(r.hours) * 60;
                const hrs = Math.floor(totalMinutes / 60);
                const mins = Math.round(totalMinutes % 60);
                const timeDisplay = r.hoursDisplay || `${hrs}å°æ—¶${mins}åˆ†é’Ÿ`;
                
                return `
                <tr>
                    <td>${r.date}</td>
                    <td><strong>${r.employee}</strong></td>
                    <td>${r.startTime}</td>
                    <td>${r.endTime}</td>
                    <td><strong>${timeDisplay}</strong></td>
                    <td><button class="delete-btn" onclick="deleteRecord(${r.id})">åˆ é™¤</button></td>
                </tr>
                `;
            }).join('');
        }

        // å¯¼å‡ºExcel
        function exportToExcel() {
            const records = JSON.parse(localStorage.getItem('timeRecords') || '[]');
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthRecords = records.filter(r => r.date.startsWith(currentMonth));

            if (monthRecords.length === 0) {
                alert('æœ¬æœˆæš‚æ— è®°å½•å¯å¯¼å‡ºï¼');
                return;
            }

            // æŒ‰å‘˜å·¥å’Œæ—¥æœŸæ’åº
            monthRecords.sort((a, b) => {
                if (a.employee !== b.employee) return a.employee.localeCompare(b.employee);
                return new Date(a.date) - new Date(b.date);
            });

            // è®¡ç®—æ¯äººæ€»è®¡
            const employeeHours = {};
            monthRecords.forEach(r => {
                employeeHours[r.employee] = (employeeHours[r.employee] || 0) + parseFloat(r.hours);
            });

            // ç”ŸæˆCSVå†…å®¹
            let csv = '\uFEFF'; // UTF-8 BOM
            csv += 'æ—¥æœŸ,å‘˜å·¥,ä¸Šç­æ—¶é—´,ä¸‹ç­æ—¶é—´,å·¥ä½œæ—¶é•¿(å°æ—¶)\n';
            
            monthRecords.forEach(r => {
                csv += `${r.date},${r.employee},${r.startTime},${r.endTime},${r.hours}\n`;
            });

            csv += '\næœˆåº¦æ±‡æ€»\n';
            Object.keys(employeeHours).forEach(name => {
                csv += `${name},,,,${employeeHours[name].toFixed(2)}\n`;
            });

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å‘˜å·¥å·¥æ—¶è®°å½•_${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ.csv`;
            link.click();

            alert('âœ… å¯¼å‡ºæˆåŠŸï¼');
        }
    </script>
</body>
</html>
